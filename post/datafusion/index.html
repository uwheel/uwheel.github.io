<!DOCTYPE html><html lang="en"> <head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><meta name="generator" content="Astro v4.11.3"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="sitemap" href="/sitemap-index.xml"><!-- SEO --><title>Speeding up Temporal Aggregation in DataFusion by 60-60000x | µWheel</title><meta name="title" content="Speeding up Temporal Aggregation in DataFusion by 60-60000x"><meta name="description" content="Using µWheel for Temporal OLAP Indexing"><meta name="author" content="Max Meldrum"><!-- OG --><meta property="og:title" content="Speeding up Temporal Aggregation in DataFusion by 60-60000x"><meta property="og:description" content="Using µWheel for Temporal OLAP Indexing"><meta property="og:url" content="https://uwheel.github.io/post/datafusion/"><meta property="og:image" content="https://uwheel.github.io/media/posts/berg4.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://uwheel.github.io/post/datafusion/"><meta property="twitter:title" content="Speeding up Temporal Aggregation in DataFusion by 60-60000x"><meta property="twitter:description" content="Using µWheel for Temporal OLAP Indexing"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><link rel="stylesheet" href="/_astro/index.CpSEASYn.css">
<style>@keyframes astroFadeInOut{0%{opacity:1}to{opacity:0}}@keyframes astroFadeIn{0%{opacity:0}}@keyframes astroFadeOut{to{opacity:0}}@keyframes astroSlideFromRight{0%{transform:translate(100%)}}@keyframes astroSlideFromLeft{0%{transform:translate(-100%)}}@keyframes astroSlideToRight{to{transform:translate(100%)}}@keyframes astroSlideToLeft{to{transform:translate(-100%)}}@media (prefers-reduced-motion){::view-transition-group(*),::view-transition-old(*),::view-transition-new(*){animation:none!important}[data-astro-transition-scope]{animation:none!important}}
@font-face{font-family:Inter;font-style:normal;font-display:swap;font-weight:400;src:url(/_astro/inter-cyrillic-ext-400-normal.tyfMZHQw.woff2) format("woff2"),url(/_astro/inter-cyrillic-ext-400-normal.CzG7Kr3z.woff) format("woff");unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:Inter;font-style:normal;font-display:swap;font-weight:400;src:url(/_astro/inter-cyrillic-400-normal.Df6ckaLK.woff2) format("woff2"),url(/_astro/inter-cyrillic-400-normal.JrS_4yms.woff) format("woff");unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:Inter;font-style:normal;font-display:swap;font-weight:400;src:url(/_astro/inter-greek-ext-400-normal.CIdlr5YK.woff2) format("woff2"),url(/_astro/inter-greek-ext-400-normal._Rr29XE2.woff) format("woff");unicode-range:U+1F00-1FFF}@font-face{font-family:Inter;font-style:normal;font-display:swap;font-weight:400;src:url(/_astro/inter-greek-400-normal.DQXyrmoy.woff2) format("woff2"),url(/_astro/inter-greek-400-normal.DvIPHDQ7.woff) format("woff");unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:Inter;font-style:normal;font-display:swap;font-weight:400;src:url(/_astro/inter-vietnamese-400-normal.Cnt0N5Vm.woff2) format("woff2"),url(/_astro/inter-vietnamese-400-normal.DIOGfGLL.woff) format("woff");unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:Inter;font-style:normal;font-display:swap;font-weight:400;src:url(/_astro/inter-latin-ext-400-normal.D3W-OpO-.woff2) format("woff2"),url(/_astro/inter-latin-ext-400-normal.8tIzm-yw.woff) format("woff");unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:Inter;font-style:normal;font-display:swap;font-weight:400;src:url(/_astro/inter-latin-400-normal.BT1H-PT_.woff2) format("woff2"),url(/_astro/inter-latin-400-normal.Cdi8t5Mu.woff) format("woff");unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}.astro-route-announcer{position:absolute;left:0;top:0;clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden;white-space:nowrap;width:1px;height:1px}:not(.astro-code *){font-family:Inter,sans-serif}
:target{scroll-margin-top:80px!important}article a{color:#075985!important}.dark article a{color:#38bdf8!important}article table{table-layout:auto;border:1px solid #d1d5db;border-radius:4px}article table{border-bottom:1px solid #fafafa}.dark article table{border:1px solid #374151}code:before,code:after{display:none}.astro-code{font-size:16px}p code{border-radius:4px;padding:2px 4px;white-space:normal!important}.dark p code{color:#d0d0d0!important;background:#07598566!important}html:not(.dark) p code{color:#000!important;background:#7fc3e766!important}.dark article blockquote{border-left-color:#064566!important}html:not(.dark) article blockquote{border-left-width:.25rem;border-left-style:solid;border-left-color:#63c8ff!important}html.dark .astro-code,html.dark .astro-code span{color:var(--shiki-dark)!important;background-color:var(--shiki-dark-bg)!important;font-style:var(--shiki-dark-font-style)!important;font-weight:var(--shiki-dark-font-weight)!important;text-decoration:var(--shiki-dark-text-decoration)!important}
</style><script type="module" src="/_astro/hoisted.y0zVRpc3.js"></script>
<script type="module" src="/_astro/page.D0Zdqonr.js"></script><style>[data-astro-transition-scope="astro-x7amp3kc-1"] { view-transition-name: astro-x7amp3kc-1; }@layer astro { ::view-transition-old(astro-x7amp3kc-1) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(astro-x7amp3kc-1) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(astro-x7amp3kc-1) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(astro-x7amp3kc-1) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-x7amp3kc-1"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-x7amp3kc-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-x7amp3kc-1"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-x7amp3kc-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-x7amp3kc-1"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-x7amp3kc-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-x7amp3kc-1"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-x7amp3kc-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style><style>[data-astro-transition-scope="astro-x7amp3kc-2"] { view-transition-name: astro-x7amp3kc-2; }@layer astro { ::view-transition-old(astro-x7amp3kc-2) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(astro-x7amp3kc-2) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(astro-x7amp3kc-2) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(astro-x7amp3kc-2) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-x7amp3kc-2"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-x7amp3kc-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-x7amp3kc-2"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-x7amp3kc-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-x7amp3kc-2"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-x7amp3kc-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-x7amp3kc-2"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-x7amp3kc-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style><style>[data-astro-transition-scope="astro-x7amp3kc-3"] { view-transition-name: astro-x7amp3kc-3; }@layer astro { ::view-transition-old(astro-x7amp3kc-3) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(astro-x7amp3kc-3) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(astro-x7amp3kc-3) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(astro-x7amp3kc-3) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-x7amp3kc-3"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-x7amp3kc-3"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-x7amp3kc-3"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-x7amp3kc-3"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-x7amp3kc-3"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-x7amp3kc-3"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-x7amp3kc-3"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-x7amp3kc-3"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style><style>[data-astro-transition-scope="astro-x7amp3kc-4"] { view-transition-name: astro-x7amp3kc-4; }@layer astro { ::view-transition-old(astro-x7amp3kc-4) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(astro-x7amp3kc-4) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(astro-x7amp3kc-4) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(astro-x7amp3kc-4) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-x7amp3kc-4"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-x7amp3kc-4"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-x7amp3kc-4"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-x7amp3kc-4"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-x7amp3kc-4"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-x7amp3kc-4"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-x7amp3kc-4"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-x7amp3kc-4"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style><style>[data-astro-transition-scope="astro-x7amp3kc-5"] { view-transition-name: datafusion; }@layer astro { ::view-transition-old(datafusion) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(datafusion) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(datafusion) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(datafusion) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-x7amp3kc-5"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-x7amp3kc-5"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-x7amp3kc-5"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-x7amp3kc-5"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-x7amp3kc-5"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-x7amp3kc-5"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-x7amp3kc-5"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-x7amp3kc-5"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style><style>[data-astro-transition-scope="astro-x7amp3kc-6"] { view-transition-name: olap; }@layer astro { ::view-transition-old(olap) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(olap) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(olap) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(olap) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-x7amp3kc-6"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-x7amp3kc-6"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-x7amp3kc-6"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-x7amp3kc-6"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-x7amp3kc-6"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-x7amp3kc-6"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-x7amp3kc-6"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-x7amp3kc-6"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style><style>[data-astro-transition-scope="astro-x7amp3kc-7"] { view-transition-name: indexing; }@layer astro { ::view-transition-old(indexing) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(indexing) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(indexing) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(indexing) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-x7amp3kc-7"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-x7amp3kc-7"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-x7amp3kc-7"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-x7amp3kc-7"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-x7amp3kc-7"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-x7amp3kc-7"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-x7amp3kc-7"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-x7amp3kc-7"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style><style>[data-astro-transition-scope="astro-x7amp3kc-8"] { view-transition-name: rust; }@layer astro { ::view-transition-old(rust) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(rust) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(rust) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(rust) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-x7amp3kc-8"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-x7amp3kc-8"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-x7amp3kc-8"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-x7amp3kc-8"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-x7amp3kc-8"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-x7amp3kc-8"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-x7amp3kc-8"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-x7amp3kc-8"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style></head> <body class="text-gray-700 dark:text-gray-400 dark:bg-gray-950"> <header class="backdrop-blur w-full px-8 py-5 fixed z-10 border-b dark:border-gray-900 bg-white/80 dark:bg-gray-950/75"> <div class="flex items-center gap-5 mx-auto w-full max-w-3xl"> <a class="text-black dark:text-white font-medium transition-colors hover:brightness-80" href="/" class="text-lg"> <!-- SETUP: If you have a logo, replace this component with it --><span> µWheel </span> </a> <div class="flex-grow"></div> <div class="flex items-center gap-4"> <a href="/posts" class="text-gray-800 dark:text-gray-400 transition-colors hover:brightness-80"> Posts </a><a href="/tags" class="text-gray-800 dark:text-gray-400 transition-colors hover:brightness-80"> Tags </a> </div> <div class="flex items-center gap-3"> <a href="/search" aria-label="Search content" class="transition-all hover:brightness-80 hover:scale-105"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"></path><path d="M21 21l-6 -6"></path></svg> </a> <button aria-label="Switch theme" class="theme-switch transition-all hover:brightness-80 hover:scale-105"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path></svg> </button> <script>
  const iconMoon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" /></svg>`;
  const iconSun = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" /><path d="M3 12h1m8 -9v1m8 8h1m-9 8v1m-6.4 -15.4l.7 .7m12.1 -.7l-.7 .7m0 11.4l.7 .7m-12.1 -.7l-.7 .7" /></svg>`;

  function theme() {
    const local = localStorage.getItem("theme");
    if (local) {
      return local;
    }
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      return "dark";
    }
    return "light";
  }

  function registerStuff(document) {
    const root = document.documentElement;
    const themeSwitch = document.querySelector(".theme-switch");

    if (theme() === "light") {
      root.classList.remove("dark");
      themeSwitch.innerHTML = iconMoon;
    } else {
      root.classList.add("dark");
      themeSwitch.innerHTML = iconSun;
    }

    themeSwitch.addEventListener("click", () => {
      const isDark = root.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "light" : "dark");
      console.log(isDark);

      if (isDark) {
        root.classList.remove("dark");
        themeSwitch.innerHTML = iconMoon;
      } else {
        root.classList.add("dark");
        themeSwitch.innerHTML = iconSun;
      }
    });
  }

  registerStuff(document);

  document.addEventListener("astro:after-swap", (ev) => {
    registerStuff(document);
  });
</script> <a target="_blank" href="/rss.xml" aria-label="Get RSS feed" class="transition-all hover:brightness-80 hover:scale-105"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 19m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path> <path d="M4 4a16 16 0 0 1 16 16"></path> <path d="M4 11a9 9 0 0 1 9 9"></path>  </svg> </a> </div> </div> </header> <main class="px-4 pt-30 mx-auto max-w-3xl">   <div class="reading-progress z-10 fixed left-0 top-0 h-1 dark:bg-sky-500 bg-sky-700 opacity-75"></div> <script>
  /**
   * Gets the vertical scroll percent (0.0 - 1.0)
   */
  function getScrollPercent() {
    const doc = document.documentElement;
    const body = document.body;

    return (
      (doc.scrollTop || body.scrollTop) /
      ((doc.scrollHeight || body.scrollHeight) - doc.clientHeight)
    );
  }

  document.addEventListener("astro:page-load", () => {
    document.addEventListener("scroll", () => {
      const el = document.querySelector(".reading-progress");
      if (el) {
        el.style.width = `${getScrollPercent() * 100}%`;
      }
    });
  });
</script> <div class="flex flex-col gap-4"> <h1 class="text-sky-800 dark:text-sky-400 text-4xl md:text-5xl font-bold"> Speeding up Temporal Aggregation in DataFusion by 60-60000x </h1> <div class="flex items-center gap-2">  <div>
by <i>Max Meldrum</i> </div>
-
 <div> May 15, 2024 </div> 
- <div>10 min. read</div>  </div> <ul class="text-sm text-sky-800 dark:text-sky-300 flex flex-wrap items-center gap-3"> <li class="mb-2 transition-all hover:translate-y-[-1px] hover:brightness-90">  <a class="transition-all bg-sky-400/10 dark:bg-sky-800/10 hover:dark:bg-sky-800/30 rounded p-2" href="/tag/datafusion" data-astro-transition-scope="astro-x7amp3kc-5">
#datafusion </a> </li><li class="mb-2 transition-all hover:translate-y-[-1px] hover:brightness-90">  <a class="transition-all bg-sky-400/10 dark:bg-sky-800/10 hover:dark:bg-sky-800/30 rounded p-2" href="/tag/olap" data-astro-transition-scope="astro-x7amp3kc-6">
#olap </a> </li><li class="mb-2 transition-all hover:translate-y-[-1px] hover:brightness-90">  <a class="transition-all bg-sky-400/10 dark:bg-sky-800/10 hover:dark:bg-sky-800/30 rounded p-2" href="/tag/indexing" data-astro-transition-scope="astro-x7amp3kc-7">
#indexing </a> </li><li class="mb-2 transition-all hover:translate-y-[-1px] hover:brightness-90">  <a class="transition-all bg-sky-400/10 dark:bg-sky-800/10 hover:dark:bg-sky-800/30 rounded p-2" href="/tag/rust" data-astro-transition-scope="astro-x7amp3kc-8">
#rust </a> </li> </ul> <img class="mt-5 rounded-xl w-full object-cover aspect-2" src="/media/posts/berg4.jpg" alt="Blog post thumbnail"> </div>  <article class="my-10 w-full !max-w-full prose dark:prose-invert text-lg text-justify dark:prose-gray"> <p><a href="https://github.com/uwheel/uwheel">µWheel</a> is a unified aggregate management system for streams and queries. While the system is mainly designed for streaming workloads, it can also be used for OLAP indexing.
In this post, I’ll show the potential of using µWheel as an index within or on top of <a href="https://datafusion.apache.org/">DataFusion</a> to significantly speed up temporal aggregation queries.</p>
<p>There is an ongoing discussion about <a href="https://github.com/apache/datafusion/discussions/9963">indexing support</a> in DataFusion
and the following time-based analytical processing systems could benefit from native µWheel indexing support:</p>
<ul>
<li><a href="https://github.com/influxdata/influxdb">InfluxDB</a> - Time Series Database</li>
<li><a href="https://github.com/apache/incubator-horaedb">HoraeDB</a> - Distributed Time-Series Database</li>
<li><a href="https://github.com/ArroyoSystems/arroyo">Arroyo</a> - Distributed stream processing engine</li>
<li><a href="https://github.com/GreptimeTeam/greptimedb">GreptimeDB</a> - Distributed Time-Series Database</li>
<li><a href="https://github.com/cnosdb/cnosdb">CnosDB</a> - Distributed Time-Series Database</li>
</ul>
<p>Post Overview:</p>
<ul>
<li><a href="#dataset-and-queries">Dataset &#x26; Queries</a></li>
<li><a href="#datafusion-baseline">DataFusion Baseline</a></li>
<li><a href="#building-our-%C2%B5wheel-index">Building the µWheel index</a></li>
<li><a href="#%C2%B5wheel-query-execution">µWheel query execution</a></li>
<li><a href="#%C2%B5wheel-performance">µWheel Performance</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
<h1 id="dataset-and-queries">Dataset and Queries</h1>
<p>We’ll use the NYC Taxi Dataset from the year 2022 and the month of January for our benchmark.
The data is stored as Parquet. Now let us imagine that the following SQL query is frequently being executed to answer the total generated ride revenue within a time range.</p>
<pre class="astro-code astro-code-themes one-light rose-pine-moon" style="background-color:#FAFAFA;--shiki-dark-bg:#232136;color:#383A42;--shiki-dark:#e0def4; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#3E8FB0">SELECT</span><span style="color:#0184BC;--shiki-dark:#EB6F92;font-style:inherit;--shiki-dark-font-style:italic"> SUM</span><span style="color:#383A42;--shiki-dark:#E0DEF4">(fare_amount) </span><span style="color:#A626A4;--shiki-dark:#3E8FB0">FROM</span><span style="color:#383A42;--shiki-dark:#E0DEF4"> yellow_tripdata</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#3E8FB0">WHERE</span><span style="color:#383A42;--shiki-dark:#E0DEF4"> tpep_dropoff_datetime </span><span style="color:#383A42;--shiki-dark:#3E8FB0">>=</span><span style="color:#50A14F;--shiki-dark:#F6C177"> '?'</span><span style="color:#A626A4;--shiki-dark:#3E8FB0"> and</span><span style="color:#383A42;--shiki-dark:#3E8FB0"> &#x3C;</span><span style="color:#50A14F;--shiki-dark:#F6C177"> '?'</span></span>
<span class="line"></span></code></pre>
<p>So now the question is, can we acheive low latency and highly interactive querying over arbitrary time ranges using purely DataFusion + Parquet?</p>
<h1 id="datafusion-baseline">DataFusion Baseline</h1>
<p>We generate 20000 random time ranges with both <strong>minute</strong> and <strong>hour</strong> granularities between <code>2022-01-01</code> and  <code>2022-01-31</code>, and record the latency of executions.
Furthermore, we enable the mimalloc allocator and run things using a single-threaded tokio runtime since adding more tokio workers did not really improve the DataFusion performance
for our workload.</p>
<p>Benchmark code used is available <a href="https://github.com/uwheel/uwheel-datafusion">here</a> and the runs were executed on a MacBook Pro M2 machine.</p>























<table><thead><tr><th>System</th><th>p50</th><th>p99</th><th>p99.9</th></tr></thead><tbody><tr><td>DataFusion (Minute Ranges)</td><td>65559µs</td><td>68887µs</td><td>73375µs</td></tr><tr><td>DataFusion (Hour Ranges)</td><td>64793µs</td><td>67667µs</td><td>72071µs</td></tr></tbody></table>
<p>While the latencies are under 100ms, it is not really the ideal performance for highly interactive querying.</p>
<h1 id="building-our-µwheel-index">Building our µWheel index</h1>
<p>To build an µWheel index on top of Parquet data, we need the following: 1) an aggregation function; 2) a starting low watermark; 3) a wheel configuration; 4) a final low watermark to advance to once data has been ingested.</p>
<p>Since we are aggregating the fare amount from the NYC taxi dataset we’ll use µWheel’s built-in <a href="https://docs.rs/uwheel/latest/uwheel/aggregator/sum/struct.F64SumAggregator.html">F64SumAggregator</a>.  Also, since we know the start and end dates for our parquet data file (<code>2022-01-01</code> and <code>2022-01-31</code>), we can hardcode it during our building implementation.</p>
<p>The process of building the µWheel index is as follows: First, initialize a <a href="https://docs.rs/uwheel/latest/uwheel/wheels/struct.RwWheel.html">Reader-Writer Wheel</a> with a start low watermark and also configuration. In this example, we set the wheel to retain aggregates at the wheels of the minutes, hours, and days.</p>
<pre class="astro-code astro-code-themes one-light rose-pine-moon" style="background-color:#FAFAFA;--shiki-dark-bg:#232136;color:#383A42;--shiki-dark:#e0def4; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#3E8FB0">let</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> start</span><span style="color:#383A42;--shiki-dark:#3E8FB0"> =</span><span style="color:#0184BC;--shiki-dark:#9CCFD8"> NaiveDate</span><span style="color:#383A42;--shiki-dark:#3E8FB0">::</span><span style="color:#4078F2;--shiki-dark:#EA9A97">from_ymd_opt</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#986801;--shiki-dark:#EA9A97">2022</span><span style="color:#383A42;--shiki-dark:#908CAA">,</span><span style="color:#986801;--shiki-dark:#EA9A97"> 1</span><span style="color:#383A42;--shiki-dark:#908CAA">,</span><span style="color:#986801;--shiki-dark:#EA9A97"> 1</span><span style="color:#383A42;--shiki-dark:#908CAA">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">    .</span><span style="color:#4078F2;--shiki-dark:#EA9A97">unwrap</span><span style="color:#383A42;--shiki-dark:#908CAA">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">    .</span><span style="color:#4078F2;--shiki-dark:#EA9A97">and_hms_opt</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#986801;--shiki-dark:#EA9A97">0</span><span style="color:#383A42;--shiki-dark:#908CAA">,</span><span style="color:#986801;--shiki-dark:#EA9A97"> 0</span><span style="color:#383A42;--shiki-dark:#908CAA">,</span><span style="color:#986801;--shiki-dark:#EA9A97"> 0</span><span style="color:#383A42;--shiki-dark:#908CAA">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">    .</span><span style="color:#4078F2;--shiki-dark:#EA9A97">unwrap</span><span style="color:#383A42;--shiki-dark:#908CAA">();</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#3E8FB0">let</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> date</span><span style="color:#383A42;--shiki-dark:#3E8FB0"> =</span><span style="color:#0184BC;--shiki-dark:#9CCFD8"> Utc</span><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">from_utc_datetime</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#383A42;--shiki-dark:#3E8FB0">&#x26;</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic">start</span><span style="color:#383A42;--shiki-dark:#908CAA">);</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#3E8FB0">let</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> start_ms</span><span style="color:#383A42;--shiki-dark:#3E8FB0"> =</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> date</span><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">timestamp_millis</span><span style="color:#383A42;--shiki-dark:#908CAA">()</span><span style="color:#A626A4;--shiki-dark:#3E8FB0"> as</span><span style="color:#C18401;--shiki-dark:#9CCFD8"> u64</span><span style="color:#383A42;--shiki-dark:#908CAA">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#3E8FB0">let</span><span style="color:#A626A4;--shiki-dark:#3E8FB0"> mut</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> conf</span><span style="color:#383A42;--shiki-dark:#3E8FB0"> =</span><span style="color:#0184BC;--shiki-dark:#9CCFD8"> HawConf</span><span style="color:#383A42;--shiki-dark:#3E8FB0">::</span><span style="color:#4078F2;--shiki-dark:#EA9A97">default</span><span style="color:#383A42;--shiki-dark:#908CAA">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">    .</span><span style="color:#4078F2;--shiki-dark:#EA9A97">with_watermark</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic">start_ms</span><span style="color:#383A42;--shiki-dark:#908CAA">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic">conf</span><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#383A42;--shiki-dark:#E0DEF4">minutes</span><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">set_retention_policy</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#383A42;--shiki-dark:#9CCFD8">RetentionPolicy</span><span style="color:#383A42;--shiki-dark:#3E8FB0">::</span><span style="color:#0184BC;--shiki-dark:#9CCFD8">Keep</span><span style="color:#383A42;--shiki-dark:#908CAA">);</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic">conf</span><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#383A42;--shiki-dark:#E0DEF4">hours</span><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">set_retention_policy</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#383A42;--shiki-dark:#9CCFD8">RetentionPolicy</span><span style="color:#383A42;--shiki-dark:#3E8FB0">::</span><span style="color:#0184BC;--shiki-dark:#9CCFD8">Keep</span><span style="color:#383A42;--shiki-dark:#908CAA">);</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic">conf</span><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#383A42;--shiki-dark:#E0DEF4">days</span><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">set_retention_policy</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#383A42;--shiki-dark:#9CCFD8">RetentionPolicy</span><span style="color:#383A42;--shiki-dark:#3E8FB0">::</span><span style="color:#0184BC;--shiki-dark:#9CCFD8">Keep</span><span style="color:#383A42;--shiki-dark:#908CAA">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#3E8FB0">let</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> rw_conf</span><span style="color:#383A42;--shiki-dark:#3E8FB0"> =</span><span style="color:#0184BC;--shiki-dark:#9CCFD8"> Conf</span><span style="color:#383A42;--shiki-dark:#3E8FB0">::</span><span style="color:#4078F2;--shiki-dark:#EA9A97">default</span><span style="color:#383A42;--shiki-dark:#908CAA">()</span><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">with_haw_conf</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic">conf</span><span style="color:#383A42;--shiki-dark:#908CAA">);</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#3E8FB0">let</span><span style="color:#A626A4;--shiki-dark:#3E8FB0"> mut</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> wheel</span><span style="color:#383A42;--shiki-dark:#3E8FB0"> =</span><span style="color:#0184BC;--shiki-dark:#9CCFD8"> RwWheel</span><span style="color:#383A42;--shiki-dark:#3E8FB0">::</span><span style="color:#4078F2;--shiki-dark:#EA9A97">with_conf</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic">rw_conf</span><span style="color:#383A42;--shiki-dark:#908CAA">));</span></span>
<span class="line"></span></code></pre>
<p>Secondly, we scan the parquet file and filter the <code>fare_amount</code> and <code>tpep_dropoff_datetime</code> columns, which are used to create a wheel entry.</p>
<pre class="astro-code astro-code-themes one-light rose-pine-moon" style="background-color:#FAFAFA;--shiki-dark-bg:#232136;color:#383A42;--shiki-dark:#e0def4; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#3E8FB0">let</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> dropoff_array</span><span style="color:#383A42;--shiki-dark:#3E8FB0"> =</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> batch</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">column_by_name</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#50A14F;--shiki-dark:#F6C177">"tpep_dropoff_datetime"</span><span style="color:#383A42;--shiki-dark:#908CAA">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">unwrap</span><span style="color:#383A42;--shiki-dark:#908CAA">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">as_any</span><span style="color:#383A42;--shiki-dark:#908CAA">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">downcast_ref</span><span style="color:#383A42;--shiki-dark:#3E8FB0">::</span><span style="color:#383A42;--shiki-dark:#908CAA">&#x3C;</span><span style="color:#0184BC;--shiki-dark:#9CCFD8">TimestampMicrosecondArray</span><span style="color:#383A42;--shiki-dark:#908CAA">>()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">unwrap</span><span style="color:#383A42;--shiki-dark:#908CAA">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#3E8FB0">let</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> fare_array</span><span style="color:#383A42;--shiki-dark:#3E8FB0"> =</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> batch</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">column_by_name</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#50A14F;--shiki-dark:#F6C177">"fare_amount"</span><span style="color:#383A42;--shiki-dark:#908CAA">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">unwrap</span><span style="color:#383A42;--shiki-dark:#908CAA">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">as_any</span><span style="color:#383A42;--shiki-dark:#908CAA">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">downcast_ref</span><span style="color:#383A42;--shiki-dark:#3E8FB0">::</span><span style="color:#383A42;--shiki-dark:#908CAA">&#x3C;</span><span style="color:#0184BC;--shiki-dark:#9CCFD8">Float64Array</span><span style="color:#383A42;--shiki-dark:#908CAA">>()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">unwrap</span><span style="color:#383A42;--shiki-dark:#908CAA">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#3E8FB0">for</span><span style="color:#383A42;--shiki-dark:#908CAA"> (</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic">date</span><span style="color:#383A42;--shiki-dark:#908CAA">,</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> fare</span><span style="color:#383A42;--shiki-dark:#908CAA">)</span><span style="color:#A626A4;--shiki-dark:#3E8FB0"> in</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> dropoff_array</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">values</span><span style="color:#383A42;--shiki-dark:#908CAA">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">iter</span><span style="color:#383A42;--shiki-dark:#908CAA">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">zip</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic">fare_array</span><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">values</span><span style="color:#383A42;--shiki-dark:#908CAA">()</span><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">iter</span><span style="color:#383A42;--shiki-dark:#908CAA">())</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#908CAA">{</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#3E8FB0">  let</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> ts</span><span style="color:#383A42;--shiki-dark:#3E8FB0"> =</span><span style="color:#0184BC;--shiki-dark:#9CCFD8"> DateTime</span><span style="color:#383A42;--shiki-dark:#3E8FB0">::</span><span style="color:#4078F2;--shiki-dark:#EA9A97">from_timestamp_micros</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#383A42;--shiki-dark:#3E8FB0">*</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic">date</span><span style="color:#A626A4;--shiki-dark:#3E8FB0"> as</span><span style="color:#C18401;--shiki-dark:#9CCFD8"> i64</span><span style="color:#383A42;--shiki-dark:#908CAA">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">	  .</span><span style="color:#4078F2;--shiki-dark:#EA9A97">unwrap</span><span style="color:#383A42;--shiki-dark:#908CAA">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#3E8FB0">	  .</span><span style="color:#4078F2;--shiki-dark:#EA9A97">timestamp_millis</span><span style="color:#383A42;--shiki-dark:#908CAA">()</span><span style="color:#A626A4;--shiki-dark:#3E8FB0"> as</span><span style="color:#C18401;--shiki-dark:#9CCFD8"> u64</span><span style="color:#383A42;--shiki-dark:#908CAA">;</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#3E8FB0">  let</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> entry</span><span style="color:#383A42;--shiki-dark:#3E8FB0"> =</span><span style="color:#0184BC;--shiki-dark:#9CCFD8"> Entry</span><span style="color:#383A42;--shiki-dark:#3E8FB0">::</span><span style="color:#4078F2;--shiki-dark:#EA9A97">new</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#383A42;--shiki-dark:#3E8FB0">*</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic">fare</span><span style="color:#383A42;--shiki-dark:#908CAA">,</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> ts</span><span style="color:#383A42;--shiki-dark:#908CAA">);</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic">  wheel</span><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">insert</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic">entry</span><span style="color:#383A42;--shiki-dark:#908CAA">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#908CAA">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<p>Finally, once all entries have been inserted, we advance our wheel’s time (low watermark) to <code>2022-01-31</code>.
The whole building process takes around 1 seconds on my MacBook Pro M2 where most of the time is spent on advancing the wheel.</p>
<pre class="astro-code astro-code-themes one-light rose-pine-moon" style="background-color:#FAFAFA;--shiki-dark-bg:#232136;color:#383A42;--shiki-dark:#e0def4; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic">wheel</span><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">advance</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#986801;--shiki-dark:#EA9A97">31</span><span style="color:#986801;--shiki-dark:#908CAA">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">days</span><span style="color:#383A42;--shiki-dark:#908CAA">());</span></span>
<span class="line"></span></code></pre>
<p>Our queryable wheel index now contains 44640 minutes, 744 hours, and 31-day aggregates, resulting in a size of around 1.3 MiB. Note that this size could be much smaller if we utilize compression within µWheel.</p>
<h1 id="µwheel-query-execution">µWheel Query Execution</h1>
<p>To execute our queries in µWheel we use the ReaderWheel’s <a href="https://docs.rs/uwheel/latest/uwheel/wheels/read/struct.ReaderWheel.html#method.combine_range_and_lower">combine_range_and_lower</a> function to aggregate a time range.
Internally, µWheel utilises its wheel-based query optimizer that finds optimal plans based on context such as SIMD, algebraic properties, and time.</p>
<pre class="astro-code astro-code-themes one-light rose-pine-moon" style="background-color:#FAFAFA;--shiki-dark-bg:#232136;color:#383A42;--shiki-dark:#e0def4; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#3E8FB0">for</span><span style="color:#383A42;--shiki-dark:#908CAA"> (</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic">start</span><span style="color:#383A42;--shiki-dark:#908CAA">,</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> end</span><span style="color:#383A42;--shiki-dark:#908CAA">)</span><span style="color:#A626A4;--shiki-dark:#3E8FB0"> in</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> ranges</span><span style="color:#383A42;--shiki-dark:#908CAA"> {</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#3E8FB0">  let</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> range</span><span style="color:#383A42;--shiki-dark:#3E8FB0"> =</span><span style="color:#0184BC;--shiki-dark:#9CCFD8"> WheelRange</span><span style="color:#383A42;--shiki-dark:#3E8FB0">::</span><span style="color:#4078F2;--shiki-dark:#EA9A97">new_unchecked</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic">start</span><span style="color:#383A42;--shiki-dark:#908CAA">,</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> end</span><span style="color:#383A42;--shiki-dark:#908CAA">);</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#3E8FB0">  let</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> res</span><span style="color:#383A42;--shiki-dark:#3E8FB0"> =</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic"> wheel</span><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">read</span><span style="color:#383A42;--shiki-dark:#908CAA">()</span><span style="color:#383A42;--shiki-dark:#3E8FB0">.</span><span style="color:#4078F2;--shiki-dark:#EA9A97">combine_range_and_lower</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span><span style="color:#E45649;--shiki-dark:#E0DEF4;font-style:inherit;--shiki-dark-font-style:italic">range</span><span style="color:#383A42;--shiki-dark:#908CAA">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#908CAA">}</span></span>
<span class="line"></span></code></pre>
<p>Below is an example query execution plan that µWheel generated and executed given the time range <code>2022-01-16 6:17:00</code> and <code>2022-01-27 11:09:00</code>.</p>
<pre class="astro-code astro-code-themes one-light rose-pine-moon" style="background-color:#FAFAFA;--shiki-dark-bg:#232136;color:#383A42;--shiki-dark:#e0def4; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">CombinedAggregation</span><span style="color:#50A14F;--shiki-dark:#F6C177"> {</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">    aggregations:</span><span style="color:#383A42;--shiki-dark:#E0DEF4"> [</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">        WheelAggregation</span><span style="color:#50A14F;--shiki-dark:#F6C177"> {</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            range:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> WheelRange</span><span style="color:#50A14F;--shiki-dark:#F6C177"> {</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                start:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> 2022-01-16</span><span style="color:#50A14F;--shiki-dark:#F6C177"> 6:17:00.0</span><span style="color:#50A14F;--shiki-dark:#F6C177"> +00:00:00,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">                end: 2022-01-16 7:00:00.0 +00:00:00,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">            },</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            plan:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> Scan</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                43,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#908CAA">            )</span><span style="color:#50A14F;--shiki-dark:#F6C177">,</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            slots:</span><span style="color:#383A42;--shiki-dark:#E0DEF4"> (</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                22620,</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                22663,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">            ),</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            granularity:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> Minute,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">        },</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">        WheelAggregation</span><span style="color:#50A14F;--shiki-dark:#F6C177"> {</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            range:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> WheelRange</span><span style="color:#50A14F;--shiki-dark:#F6C177"> {</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                start:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> 2022-01-27</span><span style="color:#50A14F;--shiki-dark:#F6C177"> 11:00:00.0</span><span style="color:#50A14F;--shiki-dark:#F6C177"> +00:00:00,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">                end: 2022-01-27 11:09:00.0 +00:00:00,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">            },</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            plan:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> Scan</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                9,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#908CAA">            )</span><span style="color:#50A14F;--shiki-dark:#F6C177">,</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            slots:</span><span style="color:#383A42;--shiki-dark:#E0DEF4"> (</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                6531,</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                6540,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">            ),</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            granularity:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> Minute,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">        },</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">        WheelAggregation</span><span style="color:#50A14F;--shiki-dark:#F6C177"> {</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            range:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> WheelRange</span><span style="color:#50A14F;--shiki-dark:#F6C177"> {</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                start:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> 2022-01-16</span><span style="color:#50A14F;--shiki-dark:#F6C177"> 7:00:00.0</span><span style="color:#50A14F;--shiki-dark:#F6C177"> +00:00:00,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">                end: 2022-01-17 0:00:00.0 +00:00:00,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">            },</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            plan:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> Scan</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                17,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#908CAA">            )</span><span style="color:#50A14F;--shiki-dark:#F6C177">,</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            slots:</span><span style="color:#383A42;--shiki-dark:#E0DEF4"> (</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                360,</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                377,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">            ),</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            granularity:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> Hour,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">        },</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">        WheelAggregation</span><span style="color:#50A14F;--shiki-dark:#F6C177"> {</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            range:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> WheelRange</span><span style="color:#50A14F;--shiki-dark:#F6C177"> {</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                start:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> 2022-01-27</span><span style="color:#50A14F;--shiki-dark:#F6C177"> 0:00:00.0</span><span style="color:#50A14F;--shiki-dark:#F6C177"> +00:00:00,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">                end: 2022-01-27 11:00:00.0 +00:00:00,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">            },</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            plan:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> Scan</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                11,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#908CAA">            )</span><span style="color:#50A14F;--shiki-dark:#F6C177">,</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            slots:</span><span style="color:#383A42;--shiki-dark:#E0DEF4"> (</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                109,</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                120,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">            ),</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            granularity:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> Hour,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">        },</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">        WheelAggregation</span><span style="color:#50A14F;--shiki-dark:#F6C177"> {</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            range:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> WheelRange</span><span style="color:#50A14F;--shiki-dark:#F6C177"> {</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                start:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> 2022-01-17</span><span style="color:#50A14F;--shiki-dark:#F6C177"> 0:00:00.0</span><span style="color:#50A14F;--shiki-dark:#F6C177"> +00:00:00,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">                end: 2022-01-27 0:00:00.0 +00:00:00,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">            },</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            plan:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> Scan</span><span style="color:#383A42;--shiki-dark:#908CAA">(</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                10,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#908CAA">            )</span><span style="color:#50A14F;--shiki-dark:#F6C177">,</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            slots:</span><span style="color:#383A42;--shiki-dark:#E0DEF4"> (</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                5,</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">                15,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">            ),</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#EA9A97">            granularity:</span><span style="color:#50A14F;--shiki-dark:#F6C177"> Day,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">        },</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">    ],</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">  },</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#E0DEF4">)</span></span>
<span class="line"></span></code></pre>
<h1 id="µwheel-performance">µWheel Performance</h1>
<p>We now execute the same time ranges in µWheel. It is important to note that there is some additional noise in DataFusion since it parses a SQL query whereas queries in µWheel do not require any form of parsing. However it should
have limited impact on the the overall execution time. Finally, explicit SIMD support was disabled for µWheel.</p>



































<table><thead><tr><th>System</th><th>p50</th><th>p99</th><th>p99.9</th></tr></thead><tbody><tr><td>DataFusion (Minute Ranges)</td><td>65559µs</td><td>68887µs</td><td>73375µs</td></tr><tr><td>DataFusion (Hour Ranges)</td><td>64793µs</td><td>67667µs</td><td>72071µs</td></tr><tr><td>µWheel (Minute Ranges)</td><td><strong>984µs</strong></td><td><strong>1038µs</strong></td><td><strong>1090µs</strong></td></tr><tr><td>µWheel (Hour Ranges)</td><td><strong>1µs</strong></td><td><strong>1µs</strong></td><td><strong>1µs</strong></td></tr></tbody></table>
<p>The results show that µWheel has significantly lower tail latencies. This of course makes sense since it pre-materializes aggregates over multiple time dimensions, uses event-time indexed wheel slots
which enables fast lookups, and employs a specialized query optimizer whose cost function aims to minimize the number of aggregate operations required for any arbitrary time range.</p>
<p>For the hour ranges, µWheel mostly spends time aggregating across its hour wheel with 744 slots which is more CPU friendly compared to jumping around and aggregating
across minutes, hours, and day wheels. Introducing compression at the minutes dimension making µWheel more cache friendly could potentially improve the overall performance.</p>
<h1 id="summary">Summary</h1>
<p>µWheel is an embeddable aggregate management system for streams and queries. It is highly space-efficient and executes temporal aggregation queries at low latencies
through a wheel-based optimizer that finds optimal plans based on context such as SIMD, algebraic properties, and time.</p>
<p>In this post we show the potential of embedding µWheel as an index to DataFusion to significantly speed up temporal aggregation queries on top of Parquet data.
An integration that could provide out-of-the-box
performance improvements for projects that use DataFusion for time-based analytical processing.</p>
<p>Benchmark <a href="https://github.com/uwheel/uwheel-datafusion">repo</a> <br>
µWheel <a href="https://github.com/uwheel/uwheel">repo</a></p> </article>   <hr class="h-1 mb-2 border-gray-200 dark:border-gray-700"> <div class="flex flex-col gap-3"> <div class="dark:text-gray-300 italic">Tags</div> <ul class="text-sm text-sky-800 dark:text-sky-300 flex flex-wrap items-center gap-3"> <li class="mb-2 transition-all hover:translate-y-[-1px] hover:brightness-90">  <a class="transition-all bg-sky-400/10 dark:bg-sky-800/10 hover:dark:bg-sky-800/30 rounded p-2" href="/tag/datafusion" data-astro-transition-scope="astro-x7amp3kc-1">
#datafusion </a> </li><li class="mb-2 transition-all hover:translate-y-[-1px] hover:brightness-90">  <a class="transition-all bg-sky-400/10 dark:bg-sky-800/10 hover:dark:bg-sky-800/30 rounded p-2" href="/tag/olap" data-astro-transition-scope="astro-x7amp3kc-2">
#olap </a> </li><li class="mb-2 transition-all hover:translate-y-[-1px] hover:brightness-90">  <a class="transition-all bg-sky-400/10 dark:bg-sky-800/10 hover:dark:bg-sky-800/30 rounded p-2" href="/tag/indexing" data-astro-transition-scope="astro-x7amp3kc-3">
#indexing </a> </li><li class="mb-2 transition-all hover:translate-y-[-1px] hover:brightness-90">  <a class="transition-all bg-sky-400/10 dark:bg-sky-800/10 hover:dark:bg-sky-800/30 rounded p-2" href="/tag/rust" data-astro-transition-scope="astro-x7amp3kc-4">
#rust </a> </li> </ul> </div>  </main> <footer class="flex flex-col gap-5 py-10 mx-auto max-w-3xl w-full"> <!-- TODO: move into a fixed FAB button, outside of footer --> <div class="text-right"> <button onclick="scrollToTop()">Back to top</button> </div> <div class="text-center">
&copy; 2024 µWheel 
- powered by <a class="text-sky-700 dark:text-sky-300 italic transition-all hover:brightness-80" href="https://github.com/marvin-j97/nanoblog" target="_blank">
nanoblog
</a>  </div> </footer> <script>
  function scrollToTop() {
    window.scrollTo({
      top: 0,
      left: 0,
      behavior: "smooth",
    });
  }
</script>  </body> </html> 